# 分类加载器使用说明

## 功能说明

`category-loader.js` 是一个用于从后端API动态加载产品分类的JavaScript模块，确保前端网站与后台管理系统的分类数据保持同步。

## 主要特性

✅ **自动加载** - 页面加载时自动从API获取最新分类数据  
✅ **数据缓存** - 5分钟缓存机制，减少不必要的API请求  
✅ **动态渲染** - 自动渲染分类树形结构到页面  
✅ **交互支持** - 支持分类选择和产品筛选  
✅ **刷新按钮** - 提供手动刷新功能  
✅ **安全防护** - HTML转义防止XSS攻击  

## 安装步骤

### 1. 在HTML中引入脚本

在你的HTML文件中添加以下代码（在 `</body>` 标签之前）：

```html
<!-- 在产品列表页面引入分类加载器 -->
<script src="assets/category-loader.js"></script>
```

### 2. 确保HTML结构正确

确保你的HTML中有以下容器元素：

```html
<div class="filter-section">
  <div class="filter-section-header">
    <h3>产品分类</h3>
  </div>
  <div class="filter-section-body">
    <div class="filter-category-list">
      <!-- 分类将自动渲染到这里 -->
    </div>
  </div>
</div>
```

### 3. 配置API地址

如果你的后端API地址不是 `http://localhost:3000/api`，请修改 `category-loader.js` 文件的第7行：

```javascript
const API_BASE_URL = 'http://your-api-domain.com/api';
```

## 使用方法

### 自动初始化

脚本会在页面加载完成后自动初始化，无需手动调用。

### 手动刷新分类

如果需要手动刷新分类数据：

```javascript
// 方法1: 使用刷新按钮
// 页面上会自动添加一个"刷新分类"按钮

// 方法2: 通过代码调用
window.CategoryLoader.refresh();
```

### 获取分类数据

```javascript
// 获取缓存的分类数据
const categories = await window.CategoryLoader.loadCategories();
console.log(categories);

// 强制从API重新加载
const freshCategories = await window.CategoryLoader.loadCategories(true);
```

### 自定义产品筛选

如果你需要在分类选择后执行自定义的产品筛选逻辑，可以定义 `loadProductsByCategories` 函数：

```javascript
// 在你的主脚本中定义此函数
function loadProductsByCategories(categoryIds, subcategoryIds) {
  console.log('选中的分类ID:', categoryIds);
  console.log('选中的子分类ID:', subcategoryIds);
  
  // 这里添加你的产品筛选逻辑
  // 例如：根据分类ID筛选产品列表
  filterProductList(categoryIds, subcategoryIds);
}
```

## API数据格式

### 请求

```
GET http://localhost:3000/api/product-categories?includeProducts=true
```

### 响应格式

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "厨房电器",
      "parentId": null,
      "icon": "Coffee",
      "description": "各类厨房电器产品",
      "sortOrder": 10,
      "status": "active",
      "productCount": 15,
      "children": [
        {
          "id": 2,
          "name": "吸油烟机",
          "parentId": 1,
          "icon": null,
          "description": "",
          "sortOrder": 5,
          "status": "active",
          "productCount": 5
        }
      ]
    }
  ]
}
```

## 样式自定义

分类加载器会生成以下HTML结构，你可以通过CSS自定义样式：

```css
/* 分类容器 */
.filter-category {
  margin-bottom: 12px;
}

/* 分类头部 */
.category-header {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  cursor: pointer;
}

.category-header:hover {
  background-color: #f3f4f6;
}

/* 分类名称 */
.category-header label {
  flex: 1;
  margin-left: 8px;
  cursor: pointer;
}

/* 产品数量 */
.category-count {
  background-color: #e5e7eb;
  color: #6b7280;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
}

/* 子分类容器 */
.category-children {
  margin-left: 24px;
  margin-top: 4px;
}

/* 子分类项 */
.filter-subcategory {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  cursor: pointer;
}

.filter-subcategory:hover {
  background-color: #f9fafb;
}

/* 刷新按钮 */
.refresh-categories-btn {
  margin: 10px 0;
  padding: 8px 16px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.refresh-categories-btn:hover {
  background: #2563eb;
  transform: translateY(-2px);
}

.refresh-categories-btn:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}
```

## 调试技巧

### 1. 查看加载日志

打开浏览器控制台（F12），查看分类加载日志：

```
初始化分类加载器...
从API加载分类数据...
分类数据加载成功: [...]
已渲染 5 个分类
```

### 2. 检查API请求

在浏览器开发者工具的 Network 标签中查看 API 请求：
- 请求URL: `http://localhost:3000/api/product-categories?includeProducts=true`
- 响应状态: 应该是 200
- 响应数据: 应该包含 `success: true` 和 `data` 数组

### 3. 测试分类选择

```javascript
// 在控制台中测试分类选择
handleCategoryChange(1); // 选择ID为1的分类
handleSubcategoryChange(2, 1); // 选择ID为2的子分类（父分类ID为1）
```

## 常见问题

### Q1: 分类不显示
**原因**: 
- API地址配置错误
- 后端服务未启动
- HTML容器元素不存在

**解决**:
1. 检查控制台错误信息
2. 确认后端服务运行在 `http://localhost:3000`
3. 确认HTML中存在 `.filter-category-list` 元素

### Q2: 分类数据不更新
**原因**: 使用了缓存数据

**解决**:
1. 点击"刷新分类"按钮
2. 或调用 `window.CategoryLoader.refresh()`
3. 或等待5分钟缓存自动过期

### Q3: 跨域问题
**原因**: 前端和后端不在同一域名

**解决**:
在后端添加CORS支持（已在 `backend/src/app.js` 中配置）

## 与后台管理系统的同步

### 工作流程

1. **后台创建分类** → 后端数据库更新
2. **前端网站访问** → 自动从API获取最新数据
3. **数据渲染** → 显示最新的分类列表

### 实时性

- **首次加载**: 立即从API获取最新数据
- **缓存期间**: 使用缓存数据（5分钟）
- **手动刷新**: 可随时强制刷新

### 测试同步

1. 在后台管理系统创建新分类
2. 在前端网站点击"刷新分类"按钮
3. 确认新分类出现在列表中

## 性能优化

### 缓存机制
- 默认缓存时间: 5分钟
- 减少不必要的API请求
- 提升页面加载速度

### 修改缓存时间

```javascript
// 在 category-loader.js 中修改第10行
const CACHE_DURATION = 10 * 60 * 1000; // 改为10分钟
```

## 扩展功能

### 添加搜索功能

```javascript
function searchCategories(keyword) {
  const categories = document.querySelectorAll('.filter-category');
  categories.forEach(cat => {
    const label = cat.querySelector('.category-header label');
    const text = label.textContent.toLowerCase();
    const match = text.includes(keyword.toLowerCase());
    cat.style.display = match ? 'block' : 'none';
  });
}
```

### 添加展开/折叠功能

```javascript
document.querySelectorAll('.category-header').forEach(header => {
  header.addEventListener('click', (e) => {
    if (e.target.tagName !== 'INPUT') {
      const children = header.nextElementSibling;
      if (children && children.classList.contains('category-children')) {
        children.style.display = 
          children.style.display === 'none' ? 'block' : 'none';
      }
    }
  });
});
```

## 技术支持

如有问题，请查看：
1. 浏览器控制台的错误信息
2. Network 标签中的API请求详情
3. 后端服务器日志

---

**版本**: 1.0.0  
**最后更新**: 2025-11-27
