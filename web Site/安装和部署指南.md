# 容电厨电网站安装和部署指南

## 系统要求

### 前端
- Node.js 14.0 或更高版本
- npm 6.0 或更高版本

### 后端
- Node.js 14.0 或更高版本
- npm 6.0 或更高版本
- MySQL 8.0 或更高版本

### 服务器
- 推荐配置：4核CPU，8GB RAM，50GB SSD
- 操作系统：Ubuntu 20.04 LTS 或 CentOS 8
- Web服务器：Nginx 1.18 或更高版本
- SSL证书（用于HTTPS）

## 目录结构创建

1. 运行提供的批处理文件以创建完整的目录结构：

```bash
./create_backend_structure.bat
```

## 开发环境设置

### 后端设置

1. 进入后端目录：

```bash
cd "web Site/server"
```

2. 初始化Node.js项目：

```bash
npm init -y
```

3. 安装所需依赖：

```bash
npm install express mongoose dotenv bcryptjs jsonwebtoken multer winston cors helmet express-validator morgan nodemailer
```

4. 安装开发依赖：

```bash
npm install --save-dev nodemon jest supertest eslint prettier
```

5. 配置环境变量，创建`.env`文件：

```
PORT=3000
NODE_ENV=development
MONGODB_URI=mongodb://localhost:27017/rongdian
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRE=30d
EMAIL_SERVICE=smtp.example.com
EMAIL_USERNAME=your-email@example.com
EMAIL_PASSWORD=your-email-password
EMAIL_FROM=noreply@rongdian.com
```

6. 设置启动脚本，在`package.json`文件中添加：

```json
"scripts": {
  "start": "node app.js",
  "dev": "nodemon app.js",
  "test": "jest --watchAll"
}
```

### 后台管理系统设置

1. 进入后台管理系统目录：

```bash
cd "web Site/admin"
```

2. 使用Create React App初始化项目：

```bash
npx create-react-app .
```

3. 安装所需依赖：

```bash
npm install react-router-dom axios antd @ant-design/icons redux react-redux redux-thunk moment echarts echarts-for-react jwt-decode
```

4. 安装开发依赖：

```bash
npm install --save-dev eslint prettier eslint-plugin-react eslint-config-prettier
```

5. 在`src`目录下创建环境变量文件`.env.development`：

```
REACT_APP_API_URL=http://localhost:3000/api/v1
REACT_APP_NAME=容电厨电管理系统
```

## 数据库设置

1. 创建MySQL数据库：

```sql
CREATE DATABASE rongdian_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. 创建数据库用户并授权：

```sql
CREATE USER 'rongdian_user'@'localhost' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON rongdian_db.* TO 'rongdian_user'@'localhost';
FLUSH PRIVILEGES;
```

3. 导入数据库初始结构（需先创建相应SQL文件）：

```bash
mysql -u rongdian_user -p rongdian_db < database/migrations/initial_schema.sql
```

## 运行开发环境

### 后端服务器

```bash
cd "web Site/server"
npm run dev
```

### 后台管理系统

```bash
cd "web Site/admin"
npm start
```

## 生产环境部署

### 后端部署

1. 在服务器上安装所需软件：

```bash
sudo apt update
sudo apt install nodejs npm nginx mysql-server
```

2. 安装PM2进程管理器：

```bash
sudo npm install -g pm2
```

3. 克隆项目代码并安装依赖：

```bash
git clone your-repository-url
cd "web Site/server"
npm install --production
```

4. 设置生产环境变量：

```bash
cp .env.example .env
nano .env  # 编辑生产环境配置
```

5. 使用PM2启动应用：

```bash
pm2 start app.js --name "rongdian-api"
pm2 startup  # 设置开机自启
pm2 save
```

### 前端部署

1. 构建生产版本：

```bash
cd "web Site/admin"
npm run build
```

2. 配置Nginx作为静态文件服务器：

```nginx
server {
    listen 80;
    server_name admin.rongdian.com;
    root /path/to/web Site/admin/build;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 代理API请求
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

server {
    listen 80;
    server_name rongdian.com www.rongdian.com;
    root /path/to/web Site/web PC;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 移动端子域名
    location /mobile {
        alias /path/to/web Site/web Mobile;
        try_files $uri $uri/ /index.html;
    }

    # 代理API请求
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

3. 启用Nginx配置：

```bash
sudo ln -s /etc/nginx/sites-available/rongdian.conf /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

## SSL设置（HTTPS）

1. 安装Certbot：

```bash
sudo apt install certbot python3-certbot-nginx
```

2. 获取SSL证书：

```bash
sudo certbot --nginx -d rongdian.com -d www.rongdian.com -d admin.rongdian.com
```

3. 设置自动续期：

```bash
sudo systemctl enable certbot.timer
```

## 数据库备份策略

1. 创建备份脚本`backup.sh`：

```bash
#!/bin/bash
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/path/to/backup/database"
DB_USER="rongdian_user"
DB_PASSWORD="strong_password"
DB_NAME="rongdian_db"

# 创建备份目录（如果不存在）
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u$DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/$DB_NAME-$TIMESTAMP.sql

# 压缩备份文件
gzip $BACKUP_DIR/$DB_NAME-$TIMESTAMP.sql

# 保留最近30天的备份
find $BACKUP_DIR -name "*.sql.gz" -type f -mtime +30 -delete
```

2. 添加执行权限并设置定时任务：

```bash
chmod +x backup.sh
crontab -e

# 添加以下行，每天凌晨3点执行备份
0 3 * * * /path/to/backup.sh
```

## 监控和日志

1. 设置日志轮转（`/etc/logrotate.d/rongdian`）：

```
/path/to/web Site/server/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -s /run/nginx.pid ] && kill -USR1 `cat /run/nginx.pid`
    endscript
}
```

2. 使用PM2监控应用：

```bash
pm2 monit
```

## 故障排除

### 常见问题及解决方法

1. **数据库连接失败**
   - 检查数据库服务是否运行：`systemctl status mysql`
   - 验证数据库凭据是否正确
   - 确认数据库用户权限是否足够

2. **Nginx错误**
   - 检查错误日志：`cat /var/log/nginx/error.log`
   - 验证配置文件语法：`nginx -t`
   - 重启Nginx：`systemctl restart nginx`

3. **Node.js应用崩溃**
   - 查看PM2日志：`pm2 logs rongdian-api`
   - 检查应用日志：`cat /path/to/web Site/server/logs/error.log`
   - 确认环境变量是否正确设置

4. **前端资源加载失败**
   - 检查浏览器控制台错误
   - 验证构建文件是否正确生成
   - 确认Nginx配置中的路径是否正确

## 安全最佳实践

1. 定期更新所有软件包
2. 启用防火墙，只开放必要端口
3. 设置强密码和定期轮换
4. 实施IP限制和速率限制
5. 定期审计系统和应用日志
6. 启用HTTPS并强制使用安全连接
7. 正确配置Content-Security-Policy头
8. 定期进行安全漏洞扫描 