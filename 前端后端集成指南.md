# 前端与后端集成指南

## 📋 完成的工作

### ✅ 已创建的文件

#### 1. **API工具函数** (`web Site/web PC/assets/js/api.js`)
- 封装了所有后端API调用
- 包含产品、分类、订阅相关接口
- 提供加载提示、错误提示、成功提示等UI反馈功能

#### 2. **API样式文件** (`web Site/web PC/assets/css/api.css`)
- 加载动画样式
- 提示框样式
- 骨架屏样式
- 空状态和错误状态样式

#### 3. **产品动态加载器** (`web Site/web PC/assets/js/products-loader.js`)
- 从后端API动态加载产品列表
- 支持分类筛选
- 支持分页功能
- 产品卡片渲染

#### 4. **订阅表单处理** (`web Site/web PC/assets/js/subscription.js`)
- 处理订阅表单提交
- 表单验证（邮箱、手机号、微信号）
- 与后端API集成

#### 5. **产品详情加载器** (`web Site/web PC/assets/js/product-detail-loader.js`)
- 从URL参数获取产品ID
- 加载产品详情
- 支持加载自定义详情页HTML文件
- 默认模板渲染

### ✅ 已修改的文件

1. **首页** (`web Site/web PC/index.html`)
   - 添加了API样式引用
   - 添加了API和订阅功能JS引用

2. **产品页面** (`web Site/web PC/pages/products.html`)
   - 添加了API样式引用
   - 添加了API和订阅功能JS引用

---

## 🚀 启动和测试步骤

### 第一步：启动后端服务

1. 打开终端，进入后端目录：
```bash
cd "c:\Users\13350\Desktop\oai 08\backend"
```

2. 确保已安装依赖（如果还没安装）：
```bash
npm install
```

3. 确保MySQL数据库已启动并创建了数据库：
```sql
CREATE DATABASE IF NOT EXISTS subscription_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

4. 运行数据库迁移：
```bash
npm run db:migrate
```

5. 启动后端服务：
```bash
npm run dev
```

后端服务将在 `http://localhost:3000` 启动

### 第二步：访问前端网站

1. 在浏览器中打开：`http://localhost:3000/index.html`

2. 或者使用VS Code的Live Server插件打开 `web Site/web PC/index.html`

---

## 🧪 功能测试清单

### 1. 订阅功能测试

#### 测试页面：首页页脚
1. 滚动到页面底部，找到订阅表单
2. 输入邮箱地址（例如：test@example.com）
3. 点击"订阅"按钮
4. 应该看到成功提示："订阅成功！我们会及时向您推送最新资讯"

#### 测试场景：
- ✅ 有效邮箱订阅
- ✅ 无效邮箱格式（应显示错误提示）
- ✅ 重复订阅（应显示"该联系方式已订阅"）
- ✅ 手机号订阅（如果表单支持）
- ✅ 微信号订阅（如果表单支持）

### 2. 产品列表加载测试（需要先添加产品数据）

#### 前置条件：在数据库中添加测试产品
可以通过管理后台或直接在数据库中插入测试数据：

```sql
-- 插入测试分类
INSERT INTO product_categories (name, description, icon, sort_order, status) 
VALUES 
('抽油烟机', '高效静音抽油烟机系列', 'bi-fan', 1, 'active'),
('燃气灶', '精准控火燃气灶系列', 'bi-fire', 2, 'active'),
('热水器', '恒温舒适热水器系列', 'bi-droplet', 3, 'active');

-- 插入测试产品
INSERT INTO products (name, model, card_image, price, short_desc, category_id, status, tag, sales, sort_order) 
VALUES 
('云魔方智能抽油烟机', 'RD-001', '/assets/images/product center/range-hood/云魔方 抽油烟机.png', 3999.00, '自动感应控制，高效静音电机，智能APP控制', 1, 'active', '热销', 128, 1),
('星火Pro燃气灶', 'RD-002', '/assets/images/product center/gas-stove/星火Pro 燃气灶.png', 2599.00, '200档火力控制，熄火自动保护，热效率高达75%', 2, 'active', '新品', 85, 2),
('恒温星燃气热水器', 'RD-003', '/assets/images/product center/water-heater/恒温星 热水器.png', 3299.00, '0.1℃恒温控制，多重安全保护，水气双调节技术', 3, 'active', '推荐', 156, 3);
```

#### 测试步骤：
1. 访问产品中心页面：`http://localhost:3000/pages/products.html`
2. 页面应该显示从后端加载的产品列表
3. 测试分类筛选功能
4. 测试分页功能（如果产品数量超过12个）

### 3. 产品详情页测试

1. 点击任意产品卡片的"查看详情"按钮
2. 应该跳转到产品详情页，URL格式：`product-detail.html?id=1`
3. 页面应该显示产品的详细信息

---

## 🔧 API接口说明

### 后端API基础地址
```
http://localhost:3000/api
```

### 主要接口

#### 1. 订阅接口
```
POST /api/subscriptions
Content-Type: application/json

{
  "contactType": "email",
  "contactValue": "test@example.com",
  "source": "website_footer"
}
```

#### 2. 获取产品列表
```
GET /api/products?page=1&limit=12&status=active
```

#### 3. 获取产品详情
```
GET /api/products/{id}
```

#### 4. 获取分类列表
```
GET /api/product-categories
```

---

## 📝 使用示例

### 在任何页面中使用API

```javascript
// 1. 获取产品列表
async function loadProducts() {
    try {
        const response = await window.API.Product.getList({
            page: 1,
            limit: 12,
            status: 'active'
        });
        
        if (response.code === 200) {
            console.log('产品列表:', response.data.list);
        }
    } catch (error) {
        console.error('加载失败:', error);
    }
}

// 2. 提交订阅
async function subscribe(email) {
    try {
        const response = await window.API.Subscription.create({
            contactType: 'email',
            contactValue: email,
            source: 'website_footer'
        });
        
        if (response.code === 200) {
            window.API.showSuccess('订阅成功！');
        }
    } catch (error) {
        window.API.showError(error.message);
    }
}

// 3. 显示加载提示
window.API.showLoading('加载中...');
// ... 执行操作
window.API.hideLoading();
```

---

## 🐛 常见问题排查

### 1. 订阅提交失败
**问题**: 点击订阅按钮后显示错误

**排查步骤**:
- 检查后端服务是否正常运行（访问 http://localhost:3000/health）
- 检查浏览器控制台是否有CORS错误
- 检查数据库连接是否正常
- 检查 `.env` 文件中的数据库配置

### 2. 产品列表不显示
**问题**: 产品页面空白或显示"暂无产品"

**排查步骤**:
- 检查数据库中是否有产品数据
- 检查产品状态是否为 'active'
- 打开浏览器控制台查看API请求是否成功
- 检查API响应数据格式

### 3. 跨域问题
**问题**: 浏览器控制台显示CORS错误

**解决方案**:
- 确保后端 `.env` 文件中的 `CORS_ORIGIN` 包含前端地址
- 如果使用Live Server，添加其端口到CORS配置
- 重启后端服务使配置生效

### 4. 图片不显示
**问题**: 产品图片显示为占位符

**排查步骤**:
- 检查图片路径是否正确
- 确保图片文件存在于指定路径
- 检查后端静态资源服务是否正常

---

## 📊 数据库管理

### 查看订阅数据
```sql
SELECT * FROM subscriptions ORDER BY created_at DESC;
```

### 查看产品数据
```sql
SELECT p.*, pc.name as category_name 
FROM products p 
LEFT JOIN product_categories pc ON p.category_id = pc.id 
WHERE p.status = 'active' 
ORDER BY p.sort_order;
```

### 清空测试数据
```sql
-- 清空订阅数据
TRUNCATE TABLE subscriptions;

-- 清空产品数据（注意：会级联删除相关数据）
DELETE FROM products;
```

---

## 🎯 下一步工作

### 待完善功能

1. **产品目录页面** (`product-catalog.html`)
   - 集成产品筛选功能
   - 添加高级搜索
   - 产品对比功能

2. **产品详情页面** (`product-detail.html`)
   - 完善详情页模板
   - 添加相关产品推荐
   - 集成评论系统

3. **联系我们页面** (`contact.html`)
   - 集成联系表单提交
   - 地图集成
   - 在线客服

4. **管理后台集成**
   - 产品管理界面
   - 订阅管理界面
   - 数据统计仪表板

---

## 📞 技术支持

如果遇到问题，请检查：
1. 后端日志：`backend/logs/combined.log`
2. 浏览器控制台错误信息
3. 网络请求详情（浏览器开发者工具 - Network标签）

---

**文档版本**: v1.0  
**创建日期**: 2025-11-19  
**最后更新**: 2025-11-19
