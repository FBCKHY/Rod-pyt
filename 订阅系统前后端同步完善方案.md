# è®¢é˜…ç³»ç»Ÿå‰åç«¯åŒæ­¥å®Œå–„æ–¹æ¡ˆ

## å®Œæˆæ—¶é—´
2025-11-19 20:10

---

## ğŸ¯ ç›®æ ‡

ç¡®ä¿**å®¢æˆ·ç«¯ç½‘ç«™è®¢é˜…è¡¨å•**æäº¤åï¼Œæ•°æ®èƒ½å¤Ÿ**å®æ—¶åŒæ­¥**åˆ°**åå°ç®¡ç†ç³»ç»Ÿ**ï¼Œç®¡ç†å‘˜å¯ä»¥ç«‹å³çœ‹åˆ°æ–°çš„è®¢é˜…è®°å½•ã€‚

---

## ğŸ“Š å½“å‰ç³»ç»Ÿæ¶æ„

### æ•°æ®æµå‘

```
å®¢æˆ·ç«¯ç½‘ç«™ (å‰ç«¯)
    â†“ (ç”¨æˆ·å¡«å†™è®¢é˜…è¡¨å•)
    â†“
JavaScript APIè°ƒç”¨ (api.js)
    â†“ (POST /api/subscriptions)
    â†“
åç«¯API (subscriptionController.js)
    â†“ (æ•°æ®éªŒè¯å’Œå¤„ç†)
    â†“
æ•°æ®åº“ (PostgreSQL - subscriptionsè¡¨)
    â†“ (æ•°æ®å­˜å‚¨)
    â†“
åå°ç®¡ç†ç³»ç»Ÿ (admin)
    â†“ (æŸ¥è¯¢å’Œå±•ç¤º)
    â†“
ç®¡ç†å‘˜æŸ¥çœ‹è®¢é˜…åˆ—è¡¨
```

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. å®¢æˆ·ç«¯è®¢é˜…è¡¨å• âœ…

**æ–‡ä»¶**: `web Site/web PC/assets/js/subscription.js`

**åŠŸèƒ½**:
- âœ… è¡¨å•éªŒè¯ (é‚®ç®±/å¾®ä¿¡/æ‰‹æœºå·)
- âœ… æ•°æ®æäº¤åˆ°åç«¯API
- âœ… æˆåŠŸ/å¤±è´¥æç¤º
- âœ… é˜²é‡å¤æäº¤
- âœ… è‡ªåŠ¨è¡¨å•é‡ç½®

**ä»£ç ç¤ºä¾‹**:
```javascript
// æäº¤è®¢é˜…æ•°æ®
const response = await window.API.Subscription.create({
    contactType: 'email',      // è”ç³»æ–¹å¼ç±»å‹
    contactValue: 'user@example.com',  // è”ç³»æ–¹å¼å€¼
    source: 'website_footer'   // è®¢é˜…æ¥æº
});
```

### 2. å‰ç«¯APIé…ç½® âœ…

**æ–‡ä»¶**: `web Site/web PC/assets/js/api.js`

**é…ç½®**:
```javascript
const baseURL = 'http://localhost:3000/api';

const SubscriptionAPI = {
    create(data) {
        return request('/subscriptions', {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }
};
```

### 3. åç«¯APIæ¥å£ âœ…

**æ–‡ä»¶**: `backend/src/routes/subscriptions.js`

**è·¯ç”±**:
```javascript
POST /api/subscriptions
```

**Controller**: `backend/src/controllers/subscriptionController.js`

**åŠŸèƒ½**:
- âœ… æ¥æ”¶è®¢é˜…æ•°æ®
- âœ… æ•°æ®éªŒè¯
- âœ… é‡å¤æ£€æŸ¥
- âœ… å­˜å‚¨åˆ°æ•°æ®åº“
- âœ… è®°å½•IPå’ŒUser-Agent
- âœ… è¿”å›æˆåŠŸ/å¤±è´¥å“åº”

### 4. æ•°æ®åº“å­˜å‚¨ âœ…

**è¡¨**: `subscriptions`

**å­—æ®µ**:
```sql
- id (ä¸»é”®)
- contact_type (è”ç³»æ–¹å¼ç±»å‹: email/wechat/phone)
- contact_value (è”ç³»æ–¹å¼å€¼)
- source (æ¥æº: website_footer/contact_form/manual)
- status (çŠ¶æ€: subscribed/unsubscribed)
- ip_address (IPåœ°å€)
- user_agent (æµè§ˆå™¨ä¿¡æ¯)
- subscribed_at (è®¢é˜…æ—¶é—´)
- created_at (åˆ›å»ºæ—¶é—´)
- updated_at (æ›´æ–°æ—¶é—´)
```

### 5. åå°ç®¡ç†ç³»ç»Ÿ âœ…

**é¡µé¢**: `admin/src/views/subscription/list/index.vue`

**åŠŸèƒ½**:
- âœ… è®¢é˜…åˆ—è¡¨å±•ç¤º
- âœ… å®æ—¶æ•°æ®æŸ¥è¯¢
- âœ… æœç´¢å’Œç­›é€‰
- âœ… ç»Ÿè®¡å¡ç‰‡
- âœ… æ‰¹é‡æ“ä½œ
- âœ… Excelå¯¼å‡º

---

## ğŸ”§ éœ€è¦å®Œå–„çš„åŠŸèƒ½

### 1. å®æ—¶æ•°æ®åˆ·æ–° âš ï¸

**é—®é¢˜**: ç®¡ç†å‘˜éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°æ–°è®¢é˜…

**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ è‡ªåŠ¨åˆ·æ–°æˆ–WebSocketå®æ—¶æ¨é€

#### æ–¹æ¡ˆA: è‡ªåŠ¨å®šæ—¶åˆ·æ–° (ç®€å•)

**å®ç°æ­¥éª¤**:

1. åœ¨è®¢é˜…åˆ—è¡¨é¡µé¢æ·»åŠ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½

```vue
<!-- admin/src/views/subscription/list/index.vue -->
<script setup>
import { onMounted, onBeforeUnmount } from 'vue'

// è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
let autoRefreshTimer = null

// å¯ç”¨è‡ªåŠ¨åˆ·æ–°
const enableAutoRefresh = () => {
  // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
  autoRefreshTimer = setInterval(() => {
    fetchData()
    fetchStats()
  }, 30000) // 30ç§’
}

// ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
const disableAutoRefresh = () => {
  if (autoRefreshTimer) {
    clearInterval(autoRefreshTimer)
    autoRefreshTimer = null
  }
}

onMounted(() => {
  enableAutoRefresh()
})

onBeforeUnmount(() => {
  disableAutoRefresh()
})
</script>
```

2. æ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®å’Œè‡ªåŠ¨åˆ·æ–°å¼€å…³

```vue
<template>
  <div class="header-actions">
    <el-switch
      v-model="autoRefreshEnabled"
      active-text="è‡ªåŠ¨åˆ·æ–°"
      @change="toggleAutoRefresh"
    />
    <el-button :icon="Refresh" @click="handleRefresh">
      åˆ·æ–°
    </el-button>
  </div>
</template>
```

#### æ–¹æ¡ˆB: WebSocketå®æ—¶æ¨é€ (é«˜çº§)

**å®ç°æ­¥éª¤**:

1. åç«¯æ·»åŠ WebSocketæ”¯æŒ

```javascript
// backend/src/websocket/subscriptionSocket.js
const WebSocket = require('ws');

class SubscriptionSocket {
  constructor(server) {
    this.wss = new WebSocket.Server({ server });
    this.clients = new Set();
    
    this.wss.on('connection', (ws) => {
      this.clients.add(ws);
      
      ws.on('close', () => {
        this.clients.delete(ws);
      });
    });
  }
  
  // å¹¿æ’­æ–°è®¢é˜…
  broadcastNewSubscription(subscription) {
    const message = JSON.stringify({
      type: 'NEW_SUBSCRIPTION',
      data: subscription
    });
    
    this.clients.forEach(client => {
      if (client.readyState === WebSocket.OPEN) {
        client.send(message);
      }
    });
  }
}

module.exports = SubscriptionSocket;
```

2. åœ¨è®¢é˜…åˆ›å»ºæ—¶è§¦å‘æ¨é€

```javascript
// backend/src/controllers/subscriptionController.js
async create(req, res) {
  // ... åˆ›å»ºè®¢é˜…é€»è¾‘
  
  // æ¨é€åˆ°WebSocket
  if (global.subscriptionSocket) {
    global.subscriptionSocket.broadcastNewSubscription(subscription);
  }
  
  res.status(201).json(formatResponse(200, 'è®¢é˜…æˆåŠŸ', subscription));
}
```

3. å‰ç«¯è¿æ¥WebSocket

```typescript
// admin/src/composables/useSubscriptionSocket.ts
import { ref, onMounted, onBeforeUnmount } from 'vue'

export function useSubscriptionSocket() {
  const ws = ref<WebSocket | null>(null)
  
  const connect = () => {
    ws.value = new WebSocket('ws://localhost:3000')
    
    ws.value.onmessage = (event) => {
      const message = JSON.parse(event.data)
      
      if (message.type === 'NEW_SUBSCRIPTION') {
        // è§¦å‘åˆ·æ–°æˆ–ç›´æ¥æ·»åŠ åˆ°åˆ—è¡¨
        console.log('æ–°è®¢é˜…:', message.data)
        // å¯ä»¥è§¦å‘è‡ªå®šä¹‰äº‹ä»¶æˆ–è°ƒç”¨åˆ·æ–°å‡½æ•°
      }
    }
  }
  
  const disconnect = () => {
    ws.value?.close()
  }
  
  onMounted(() => {
    connect()
  })
  
  onBeforeUnmount(() => {
    disconnect()
  })
  
  return {
    ws
  }
}
```

### 2. æ–°è®¢é˜…é€šçŸ¥ âš ï¸

**åŠŸèƒ½**: å½“æœ‰æ–°è®¢é˜…æ—¶ï¼Œåœ¨åå°ç®¡ç†ç³»ç»Ÿæ˜¾ç¤ºé€šçŸ¥

**å®ç°æ–¹æ¡ˆ**:

```vue
<!-- admin/src/views/subscription/list/index.vue -->
<script setup>
import { ElNotification } from 'element-plus'

// ç›‘å¬æ–°è®¢é˜…äº‹ä»¶
const handleNewSubscription = (subscription) => {
  // æ˜¾ç¤ºé€šçŸ¥
  ElNotification({
    title: 'æ–°è®¢é˜…',
    message: `${subscription.contactValue} åˆšåˆšè®¢é˜…äº†`,
    type: 'success',
    duration: 5000,
    position: 'top-right'
  })
  
  // åˆ·æ–°åˆ—è¡¨
  fetchData()
  fetchStats()
}

// WebSocketæˆ–å®šæ—¶æ£€æŸ¥æ–°è®¢é˜…
</script>
```

### 3. è®¢é˜…æ¥æºæ ‡è¯†ä¼˜åŒ– âš ï¸

**å½“å‰æ¥æº**:
- `website_footer` - ç½‘ç«™åº•éƒ¨è®¢é˜…
- `contact_form` - è”ç³»è¡¨å•
- `manual` - æ‰‹åŠ¨æ·»åŠ 

**å»ºè®®æ·»åŠ **:
- é¡µé¢URL
- æ¥æºé¡µé¢æ ‡é¢˜
- æ¨èäººä¿¡æ¯

**å®ç°**:

```javascript
// web Site/web PC/assets/js/subscription.js
async handleSubmit(event) {
  // ... ç°æœ‰ä»£ç 
  
  const response = await window.API.Subscription.create({
    contactType,
    contactValue,
    source: 'website_footer',
    // æ–°å¢å­—æ®µ
    sourceUrl: window.location.href,        // å½“å‰é¡µé¢URL
    sourceTitle: document.title,            // é¡µé¢æ ‡é¢˜
    referrer: document.referrer             // æ¥æºé¡µé¢
  });
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### æµ‹è¯•æ­¥éª¤

#### 1. å¯åŠ¨åç«¯æœåŠ¡
```bash
cd backend
npm run dev
```

#### 2. å¯åŠ¨ç®¡ç†åå°
```bash
cd admin
npm run dev
```

#### 3. æ‰“å¼€å®¢æˆ·ç«¯ç½‘ç«™
```bash
# ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶
open "web Site/web PC/index.html"
```

#### 4. æµ‹è¯•è®¢é˜…æµç¨‹

**æ­¥éª¤A: æäº¤è®¢é˜…**
1. åœ¨å®¢æˆ·ç«¯ç½‘ç«™åº•éƒ¨æ‰¾åˆ°è®¢é˜…è¡¨å•
2. è¾“å…¥é‚®ç®±åœ°å€: `test@example.com`
3. ç‚¹å‡»"è®¢é˜…"æŒ‰é’®
4. è§‚å¯Ÿæ˜¯å¦æ˜¾ç¤ºæˆåŠŸæç¤º

**æ­¥éª¤B: éªŒè¯åå°**
1. æ‰“å¼€ç®¡ç†åå°: `http://localhost:3007/subscription/list`
2. æŸ¥çœ‹è®¢é˜…åˆ—è¡¨æ˜¯å¦æœ‰æ–°è®°å½•
3. æ£€æŸ¥ç»Ÿè®¡å¡ç‰‡æ•°å­—æ˜¯å¦æ›´æ–°
4. éªŒè¯è®¢é˜…è¯¦æƒ…ä¿¡æ¯æ˜¯å¦å®Œæ•´

**æ­¥éª¤C: æµ‹è¯•å®æ—¶æ€§**
1. åœ¨å®¢æˆ·ç«¯æäº¤æ–°è®¢é˜…
2. ç«‹å³åˆ‡æ¢åˆ°ç®¡ç†åå°
3. ç‚¹å‡»åˆ·æ–°æŒ‰é’®æˆ–ç­‰å¾…è‡ªåŠ¨åˆ·æ–°
4. éªŒè¯æ–°è®¢é˜…æ˜¯å¦ç«‹å³æ˜¾ç¤º

### æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•é¡¹ | æµ‹è¯•æ•°æ® | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|----------|----------|----------|
| é‚®ç®±è®¢é˜… | test@example.com | è®¢é˜…æˆåŠŸï¼Œåå°æ˜¾ç¤º | âœ… |
| å¾®ä¿¡è®¢é˜… | wechat123 | è®¢é˜…æˆåŠŸï¼Œåå°æ˜¾ç¤º | âœ… |
| æ‰‹æœºè®¢é˜… | 13800138000 | è®¢é˜…æˆåŠŸï¼Œåå°æ˜¾ç¤º | âœ… |
| é‡å¤è®¢é˜… | test@example.com | æç¤ºå·²å­˜åœ¨ | âœ… |
| æ— æ•ˆé‚®ç®± | invalid-email | æç¤ºæ ¼å¼é”™è¯¯ | âœ… |
| ç©ºå€¼æäº¤ | (ç©º) | æç¤ºå¿…å¡« | âœ… |

---

## ğŸ” é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. è®¢é˜…æäº¤å¤±è´¥

**å¯èƒ½åŸå› **:
- åç«¯æœåŠ¡æœªå¯åŠ¨
- APIåœ°å€é…ç½®é”™è¯¯
- CORSè·¨åŸŸé—®é¢˜
- æ•°æ®éªŒè¯å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:3000/api/health

# 2. æ£€æŸ¥APIé…ç½®
# æŸ¥çœ‹ web Site/web PC/assets/js/api.js
# ç¡®è®¤ baseURL = 'http://localhost:3000/api'

# 3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
# æ‰“å¼€å¼€å‘è€…å·¥å…· -> Console
# æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

# 4. æŸ¥çœ‹åç«¯æ—¥å¿—
# æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºçš„æ—¥å¿—ä¿¡æ¯
```

#### 2. åå°ä¸æ˜¾ç¤ºæ–°è®¢é˜…

**å¯èƒ½åŸå› **:
- æ•°æ®åº“è¿æ¥é—®é¢˜
- æŸ¥è¯¢æ¡ä»¶è¿‡æ»¤äº†æ–°æ•°æ®
- ç¼“å­˜é—®é¢˜

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æ•°æ®åº“
psql -U postgres -d your_database
SELECT * FROM subscriptions ORDER BY created_at DESC LIMIT 10;

# 2. æ¸…é™¤ç­›é€‰æ¡ä»¶
# åœ¨ç®¡ç†åå°ç‚¹å‡»"é‡ç½®"æŒ‰é’®

# 3. å¼ºåˆ¶åˆ·æ–°
# æŒ‰ Ctrl+Shift+R æˆ– Cmd+Shift+R
```

#### 3. CORSè·¨åŸŸé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:

```javascript
// backend/src/app.js
const cors = require('cors');

app.use(cors({
  origin: ['http://localhost:3007', 'http://127.0.0.1:5500'],
  credentials: true
}));
```

---

## ğŸ“ å®ç°æ¸…å•

### ç«‹å³å®ç° (é«˜ä¼˜å…ˆçº§)

- [x] âœ… å®¢æˆ·ç«¯è®¢é˜…è¡¨å•
- [x] âœ… å‰ç«¯APIè°ƒç”¨
- [x] âœ… åç«¯APIæ¥å£
- [x] âœ… æ•°æ®åº“å­˜å‚¨
- [x] âœ… åå°åˆ—è¡¨å±•ç¤º
- [ ] âš ï¸ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
- [ ] âš ï¸ æ–°è®¢é˜…é€šçŸ¥

### å¯é€‰å®ç° (ä¸­ä¼˜å…ˆçº§)

- [ ] WebSocketå®æ—¶æ¨é€
- [ ] è®¢é˜…æ¥æºè¯¦æƒ…
- [ ] è®¢é˜…è½¬åŒ–æ¼æ–—
- [ ] é‚®ä»¶ç¡®è®¤åŠŸèƒ½

### æœªæ¥ä¼˜åŒ– (ä½ä¼˜å…ˆçº§)

- [ ] è®¢é˜…åˆ†ææŠ¥è¡¨
- [ ] A/Bæµ‹è¯•åŠŸèƒ½
- [ ] ç”¨æˆ·ç”»åƒåˆ†æ
- [ ] æ™ºèƒ½æ¨èç³»ç»Ÿ

---

## ğŸš€ å¿«é€Ÿå®ç°è‡ªåŠ¨åˆ·æ–°

è®©æˆ‘ç«‹å³ä¸ºæ‚¨å®ç°è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼Œç¡®ä¿ç®¡ç†å‘˜èƒ½å¤Ÿå®æ—¶çœ‹åˆ°æ–°è®¢é˜…ã€‚

### å®ç°æ­¥éª¤

1. **ä¿®æ”¹è®¢é˜…åˆ—è¡¨é¡µé¢** - æ·»åŠ è‡ªåŠ¨åˆ·æ–°
2. **æ·»åŠ åˆ·æ–°æ§åˆ¶** - å¼€å…³å’Œé—´éš”è®¾ç½®
3. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ** - åˆ·æ–°æç¤ºå’ŒåŠ¨ç”»

### ä»£ç å®ç°

è§ä¸‹ä¸€ä¸ªæ–‡ä»¶...

---

## ğŸ“Š æ•°æ®åŒæ­¥éªŒè¯

### éªŒè¯ç‚¹

1. âœ… **æ•°æ®å®Œæ•´æ€§**
   - å®¢æˆ·ç«¯æäº¤çš„æ‰€æœ‰å­—æ®µéƒ½ä¿å­˜åˆ°æ•°æ®åº“
   - IPåœ°å€å’ŒUser-Agentæ­£ç¡®è®°å½•
   - æ—¶é—´æˆ³å‡†ç¡®

2. âœ… **æ•°æ®ä¸€è‡´æ€§**
   - å®¢æˆ·ç«¯çœ‹åˆ°çš„æˆåŠŸæç¤º = æ•°æ®åº“æœ‰è®°å½•
   - åå°æ˜¾ç¤ºçš„æ•°æ® = æ•°æ®åº“çš„æ•°æ®
   - ç»Ÿè®¡æ•°å­—å‡†ç¡®

3. âœ… **å®æ—¶æ€§**
   - æäº¤åç«‹å³å¯æŸ¥è¯¢
   - åˆ·æ–°åç«‹å³æ˜¾ç¤º
   - ç»Ÿè®¡æ•°æ®å®æ—¶æ›´æ–°

---

## ğŸ¯ æ€»ç»“

### å½“å‰çŠ¶æ€

**âœ… è®¢é˜…ç³»ç»Ÿå‰åç«¯å·²å®Œå…¨æ‰“é€šï¼**

- âœ… å®¢æˆ·ç«¯è®¢é˜…è¡¨å• â†’ åç«¯API â†’ æ•°æ®åº“ â†’ åå°ç®¡ç†
- âœ… æ•°æ®æµç•…é€šæ— é˜»
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### éœ€è¦æ·»åŠ 

**âš ï¸ ä»…éœ€æ·»åŠ å®æ—¶åˆ·æ–°åŠŸèƒ½**

- è‡ªåŠ¨åˆ·æ–°è®¢é˜…åˆ—è¡¨
- æ–°è®¢é˜…é€šçŸ¥æç¤º
- åˆ·æ–°æ§åˆ¶å¼€å…³

### å®æ–½å»ºè®®

1. **ç«‹å³å®æ–½**: è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ (30åˆ†é’Ÿ)
2. **çŸ­æœŸå®æ–½**: æ–°è®¢é˜…é€šçŸ¥ (1å°æ—¶)
3. **é•¿æœŸè§„åˆ’**: WebSocketå®æ—¶æ¨é€ (1å¤©)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-19 20:10  
**çŠ¶æ€**: ç³»ç»Ÿå·²æ‰“é€šï¼Œå¾…æ·»åŠ å®æ—¶åˆ·æ–°
